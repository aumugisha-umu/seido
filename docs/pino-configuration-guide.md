# Guide de Configuration Pino pour SEIDO

## üìã Vue d'ensemble

SEIDO utilise **Pino** (v9.12.0) + **pino-pretty** (v13.1.1) pour un syst√®me de logging structur√© et performant.

### ‚úÖ Configuration Actuelle (Optimis√©e pour Next.js 15 + Edge Runtime)

La configuration a √©t√© optimis√©e pour √™tre **100% compatible** avec Next.js 15 et Edge Runtime :
- **Pipe externe** (shell) pour pino-pretty ‚Üí √âvite les worker threads incompatibles avec Edge Runtime
- **Logs coloris√©s** automatiquement en d√©veloppement via `npm run dev`
- **JSON brut** disponible via `npm run dev:json` pour parsing/debugging
- **Performance optimale** sans overhead de worker threads

### üîç Pourquoi cette Approche ?

#### ‚ùå Probl√®me avec Transport Int√©gr√© (worker threads)
```typescript
// ‚ùå NE PAS FAIRE - Cause "worker has exited" errors
pino({
  transport: {
    target: 'pino-pretty', // Uses worker threads
    options: { colorize: true }
  }
})
```

**Probl√®me** : Next.js Edge Runtime (utilis√© par middleware, certains layouts) ne supporte **pas** les worker threads de Node.js, causant des crashes :
```
Error: the worker has exited
    at eval (lib\dal.ts:77:11)
```

#### ‚úÖ Solution : Pipe Externe
```bash
# package.json
"dev": "next dev 2>&1 | npx pino-pretty --colorize"
```

**Avantages** :
- ‚úÖ Compatible avec Edge Runtime (processus s√©par√©)
- ‚úÖ Fonctionne dans tous les contextes Next.js (Server Components, middleware, layouts)
- ‚úÖ Performance identique (transformation en post-traitement)
- ‚úÖ Multi-plateforme (Windows, Linux, macOS)

## üöÄ Utilisation

### Commandes Disponibles

```bash
# D√©veloppement avec logs format√©s et coloris√©s (RECOMMAND√â)
npm run dev

# D√©veloppement avec logs JSON bruts (parsing/debugging)
npm run dev:json

# Build production
npm run build

# Production (logs JSON structur√©s)
npm run start
```

### Import du Logger

```typescript
// Import du logger principal
import { logger } from '@/lib/logger'

// Import de loggers contextuels
import {
  authLogger,           // Pour l'authentification
  supabaseLogger,       // Pour les op√©rations Supabase
  interventionLogger,   // Pour les interventions
  dashboardLogger,      // Pour les dashboards
  testLogger           // Pour les tests
} from '@/lib/logger'

// Import de fonctions utilitaires
import {
  logUserAction,        // Log d'action utilisateur
  logApiCall,          // Log d'appel API
  logError,            // Log d'erreur enrichi
  logSupabaseOperation // Log d'op√©ration Supabase
} from '@/lib/logger'
```

## üìù Exemples d'Utilisation

### 1. Logs de Base

```typescript
import { logger } from '@/lib/logger'

// Logs simples
logger.info('‚úÖ Op√©ration r√©ussie')
logger.debug('üîç Information de debug')
logger.warn('‚ö†Ô∏è Attention')
logger.error('‚ùå Erreur survenue')
```

**Output en d√©veloppement :**
```
[15:36:45] INFO: ‚úÖ Op√©ration r√©ussie
[15:36:45] DEBUG: üîç Information de debug
[15:36:45] WARN: ‚ö†Ô∏è Attention
[15:36:45] ERROR: ‚ùå Erreur survenue
```

### 2. Logs avec Contexte

```typescript
import { authLogger } from '@/lib/logger'

authLogger.info({ userId: 'user-123', role: 'gestionnaire' }, 'üîê Connexion r√©ussie')
```

**Output :**
```
[15:36:45] INFO: üîê Connexion r√©ussie
    userId: "user-123"
    role: "gestionnaire"
```

### 3. Logs d'Action Utilisateur

```typescript
import { logUserAction } from '@/lib/logger'

logUserAction('create_intervention', userId, {
  interventionId: 'int-789',
  priority: 'high',
  building: 'Immeuble A'
})
```

**Output :**
```
[15:36:45] INFO: üë§ User action: create_intervention
    type: "user_action"
    action: "create_intervention"
    userId: "user-123"
    metadata: {
      "interventionId": "int-789",
      "priority": "high",
      "building": "Immeuble A"
    }
```

### 4. Logs d'Appel API

```typescript
import { logApiCall } from '@/lib/logger'

// D√©but de la requ√™te
const startTime = Date.now()

// ... traitement ...

// Log de la r√©ponse
const duration = Date.now() - startTime
logApiCall('POST', '/api/interventions', 201, duration)
```

**Output :**
```
[15:36:45] INFO: üåê API POST /api/interventions (201)
    type: "api_call"
    method: "POST"
    endpoint: "/api/interventions"
    statusCode: 201
    duration: 145
```

### 5. Logs d'Erreur Enrichis

```typescript
import { logError } from '@/lib/logger'

try {
  // Code qui peut √©chouer
  await createIntervention(data)
} catch (error) {
  logError(error as Error, 'intervention-creation', {
    userId,
    buildingId,
    attemptCount: 3
  })
  throw error
}
```

**Output :**
```
[15:36:45] ERROR: ‚ùå Error in intervention-creation: Database connection failed
    type: "error"
    context: "intervention-creation"
    metadata: {
      "userId": "user-123",
      "buildingId": "bld-456",
      "attemptCount": 3
    }
    error: {
      "name": "DatabaseError",
      "message": "Database connection failed",
      "stack": "DatabaseError: Database connection failed\n    at ..."
    }
```

### 6. Logs d'Op√©ration Supabase

```typescript
import { logSupabaseOperation } from '@/lib/logger'

const { data, error } = await supabase
  .from('interventions')
  .insert(interventionData)

logSupabaseOperation(
  'insert',
  'interventions',
  !error,
  { rowsAffected: data?.length || 0 }
)
```

**Output (succ√®s) :**
```
[15:36:45] INFO: ‚úÖ Supabase insert on interventions
    type: "supabase_operation"
    operation: "insert"
    table: "interventions"
    success: true
    metadata: {
      "rowsAffected": 1
    }
```

**Output (erreur) :**
```
[15:36:45] ERROR: ‚ùå Supabase insert on interventions
    type: "supabase_operation"
    operation: "insert"
    table: "interventions"
    success: false
    metadata: {
      "error": "duplicate key value violates unique constraint"
    }
```

## üé® Configuration par Environnement

### D√©veloppement (NODE_ENV=development ou undefined)

- **Transport** : Pipe externe vers pino-pretty
- **Niveau** : `debug` (tous les logs)
- **Format** : Texte format√© et coloris√©
- **Output** : Console (stdout/stderr)

```typescript
// Auto-d√©tect√© quand NODE_ENV=development ou undefined
const logger = createLogger()
logger.debug('Message visible en dev')
```

### Production (NODE_ENV=production)

- **Transport** : Aucun (JSON natif)
- **Niveau** : `info` (info, warn, error, fatal)
- **Format** : JSON structur√© (NDJSON)
- **Output** : Console (parsable par outils de log)

```json
{"level":30,"time":"2025-10-05T15:36:45.123Z","pid":1234,"hostname":"server-01","msg":"Op√©ration r√©ussie"}
```

### Tests (NODE_ENV=test)

- **Niveau** : `silent` (aucun log)
- **Format** : N/A
- **Output** : Aucun (√©vite pollution des tests)

```typescript
// En tests, tous les logs sont d√©sactiv√©s
const logger = createLogger()
logger.info('Ce message n\'appara√Æt pas pendant les tests')
```

## üîß Configuration Technique

### Fichier Principal : `lib/logger.ts`

```typescript
import pino from 'pino'

const createLogger = () => {
  const isDevelopment = process.env.NODE_ENV === 'development' || process.env.NODE_ENV === undefined
  const isTest = process.env.NODE_ENV === 'test'
  const isBrowser = typeof window !== 'undefined'

  // Browser-side: console wrapper simple
  if (isBrowser) {
    return pino({
      level: isDevelopment ? 'debug' : 'info',
      browser: {
        asObject: true,
        write: {
          info: (obj) => console.info(obj),
          error: (obj) => console.error(obj),
          warn: (obj) => console.warn(obj),
          debug: (obj) => console.debug(obj),
        }
      }
    })
  }

  const baseConfig = {
    level: process.env.LOG_LEVEL || (isDevelopment ? 'debug' : 'info'),
    timestamp: pino.stdTimeFunctions.isoTime,
  }

  // D√©veloppement: JSON brut (format√© par pipe externe)
  if (isDevelopment) {
    return pino(baseConfig)
  }

  // Tests (silencieux)
  if (isTest) {
    return pino({ ...baseConfig, level: 'silent' })
  }

  // Production (JSON brut)
  return pino(baseConfig)
}

export const logger = createLogger()
```

### Scripts package.json

```json
{
  "scripts": {
    "dev": "next dev 2>&1 | npx pino-pretty --colorize --translateTime \"HH:MM:ss\" --ignore \"pid,hostname\"",
    "dev:json": "next dev"
  }
}
```

### Options pino-pretty Utilis√©es

| Option | Valeur | Description |
|--------|--------|-------------|
| `--colorize` | flag | Active la colorisation des logs |
| `--translateTime` | `"HH:MM:ss"` | Format d'horodatage court |
| `--ignore` | `"pid,hostname"` | Masque PID et hostname (bruit) |
| `2>&1` | redirection | Redirige stderr vers stdout pour capture |

## üéØ Bonnes Pratiques

### 1. Utiliser les Loggers Contextuels

```typescript
// ‚ùå √âviter
import { logger } from '@/lib/logger'
logger.info({ context: 'auth' }, 'Login r√©ussi')

// ‚úÖ Pr√©f√©rer
import { authLogger } from '@/lib/logger'
authLogger.info('Login r√©ussi')
```

### 2. Ajouter des M√©tadonn√©es Structur√©es

```typescript
// ‚ùå √âviter (string interpolation)
logger.info(`User ${userId} created intervention ${interventionId}`)

// ‚úÖ Pr√©f√©rer (objet structur√©)
logger.info(
  { userId, interventionId, action: 'create_intervention' },
  'Intervention cr√©√©e'
)
```

### 3. Utiliser les Fonctions Utilitaires

```typescript
// ‚ùå √âviter (logs manuels)
logger.error({
  type: 'error',
  error: { message: error.message, stack: error.stack },
  context: 'api'
}, `Error: ${error.message}`)

// ‚úÖ Pr√©f√©rer (fonction d√©di√©e)
logError(error, 'api', { endpoint: '/api/users' })
```

### 4. Niveaux de Log Appropri√©s

| Niveau | Cas d'Usage | Exemple |
|--------|-------------|---------|
| `debug` | D√©tails techniques | `logger.debug({ query }, 'SQL query executed')` |
| `info` | √âv√©nements normaux | `logger.info('User logged in')` |
| `warn` | Situations anormales non critiques | `logger.warn('Rate limit approaching')` |
| `error` | Erreurs r√©cup√©rables | `logger.error('Payment failed, retrying')` |
| `fatal` | Erreurs critiques syst√®me | `logger.fatal('Database unreachable')` |

### 5. Performance : √âviter les Calculs Inutiles

```typescript
// ‚ùå √âviter (calcul toujours ex√©cut√©)
logger.debug(`Complex calculation: ${expensiveFunction()}`)

// ‚úÖ Pr√©f√©rer (calcul uniquement si debug actif)
if (logger.isLevelEnabled('debug')) {
  logger.debug({ result: expensiveFunction() }, 'Complex calculation')
}
```

## üß™ Tests et Diagnostic

### Script de Test Complet

```bash
# Test du logger avec exemples
npx tsx scripts/test-logger-final.ts
```

### Script de Diagnostic

```bash
# Comparaison des diff√©rentes configurations
npx tsx scripts/test-pino-logger.ts
```

### V√©rification de la Configuration

```typescript
// V√©rifier le niveau actuel
console.log('Log level:', logger.level)

// V√©rifier si un niveau est actif
if (logger.isLevelEnabled('debug')) {
  console.log('Debug logs are enabled')
}
```

## üêõ D√©pannage

### Probl√®me : Logs non format√©s (JSON brut)

**Sympt√¥me :**
```json
{"level":30,"time":"2025-10-05T15:36:45.123Z","msg":"Hello"}
```

**Solutions :**
1. V√©rifier que vous utilisez `npm run dev` (pas `npm run dev:json`)
2. V√©rifier installation pino-pretty : `npm list pino-pretty`
3. Windows PowerShell : Utiliser CMD ou Git Bash si probl√®me de pipe

### Probl√®me : Erreur "the worker has exited"

**Sympt√¥me :**
```
Error: the worker has exited
    at eval (lib\dal.ts:77:11)
```

**Solution :** ‚úÖ D√©j√† corrig√© dans la configuration actuelle
- Le logger n'utilise **pas** de transport avec worker threads
- Utilise pipe externe compatible avec Edge Runtime

### Probl√®me : Aucun log n'appara√Æt

**Solutions :**
1. V√©rifier le niveau de log : `LOG_LEVEL=debug npm run dev`
2. V√©rifier si NODE_ENV=test (logs d√©sactiv√©s)
3. V√©rifier les imports : utiliser `from '@/lib/logger'`

### Probl√®me : Pipe ne fonctionne pas (Windows)

**Solution :**
```bash
# PowerShell : Utiliser CMD
cmd /c "npm run dev"

# Ou Git Bash
bash -c "npm run dev"
```

## üìä Comparaison des Approches

### ‚ùå Transport Int√©gr√© (worker threads) - INCOMPATIBLE Edge Runtime

```typescript
// lib/logger.ts
pino({
  transport: {
    target: 'pino-pretty',
    options: { colorize: true }
  }
})
```

**Probl√®mes :**
- ‚ùå Crash avec Edge Runtime ("worker has exited")
- ‚ùå Incompatible avec middleware Next.js
- ‚ùå Incompatible avec certains layouts

### ‚úÖ Pipe Externe (processus s√©par√©) - COMPATIBLE Edge Runtime

```json
// package.json
"dev": "next dev 2>&1 | npx pino-pretty --colorize"
```

**Avantages :**
- ‚úÖ Compatible avec Edge Runtime
- ‚úÖ Fonctionne dans tous les contextes Next.js
- ‚úÖ Performance identique (post-traitement)
- ‚úÖ Multi-plateforme
- ‚úÖ Recommand√© par Pino pour environnements restreints

## üîó R√©f√©rences

- [Documentation Pino](https://getpino.io/)
- [pino-pretty](https://github.com/pinojs/pino-pretty)
- [Best Practices Pino](https://getpino.io/#/docs/best-practices)
- [Next.js Logging](https://nextjs.org/docs/app/building-your-application/optimizing/logging)
- [Next.js Edge Runtime](https://nextjs.org/docs/app/api-reference/edge)

---

**Derni√®re mise √† jour** : 2025-10-05
**Version Pino** : 9.12.0
**Version pino-pretty** : 13.1.1
**Statut** : ‚úÖ Production Ready - Compatible Edge Runtime
