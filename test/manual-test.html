<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIDO - Test manuel Phase 1</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-account {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .test-account button {
            margin-left: auto;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-account button:hover {
            background: #0056b3;
        }
        .results {
            margin-top: 20px;
        }
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ SEIDO - Validation PHASE 1 : Tests Manuels</h1>

    <div class="test-section">
        <h2>üìä M√©triques en temps r√©el</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="success-rate">0%</div>
                <div class="metric-label">Taux de succ√®s</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="avg-time">0ms</div>
                <div class="metric-label">Temps moyen d'auth</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="roles-ok">0/4</div>
                <div class="metric-label">R√¥les fonctionnels</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="dom-stable">‚ùì</div>
                <div class="metric-label">Stabilit√© DOM</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîê Comptes de test</h2>
        <div id="test-accounts">
            <div class="test-account">
                <span><strong>Admin:</strong> admin@seido.pm / Wxcvbn123</span>
                <button onclick="testLogin('admin@seido.pm', 'Wxcvbn123', 'admin')">Tester</button>
            </div>
            <div class="test-account">
                <span><strong>Gestionnaire:</strong> arthur@umumentum.com / Wxcvbn123</span>
                <button onclick="testLogin('arthur@umumentum.com', 'Wxcvbn123', 'gestionnaire')">Tester</button>
            </div>
            <div class="test-account">
                <span><strong>Prestataire:</strong> arthur+prest@seido.pm / Wxcvbn123</span>
                <button onclick="testLogin('arthur+prest@seido.pm', 'Wxcvbn123', 'prestataire')">Tester</button>
            </div>
            <div class="test-account">
                <span><strong>Locataire:</strong> arthur+loc@seido.pm / Wxcvbn123</span>
                <button onclick="testLogin('arthur+loc@seido.pm', 'Wxcvbn123', 'locataire')">Tester</button>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Tests automatis√©s</h2>
        <button onclick="runAllTests()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            üöÄ Lancer tous les tests
        </button>
        <button onclick="clearResults()" style="margin-left: 10px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            üóëÔ∏è Effacer les r√©sultats
        </button>
    </div>

    <div class="test-section">
        <h2>üìù R√©sultats des tests</h2>
        <div id="results" class="results"></div>
    </div>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            times: []
        };

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${type}`;
            resultItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.insertBefore(resultItem, resultsDiv.firstChild);
        }

        function updateMetrics() {
            const successRate = testResults.total > 0 ?
                Math.round((testResults.passed / testResults.total) * 100) : 0;
            const avgTime = testResults.times.length > 0 ?
                Math.round(testResults.times.reduce((a, b) => a + b, 0) / testResults.times.length) : 0;

            document.getElementById('success-rate').textContent = `${successRate}%`;
            document.getElementById('avg-time').textContent = `${avgTime}ms`;
            document.getElementById('roles-ok').textContent = `${testResults.passed}/${testResults.total}`;

            // Mise √† jour du statut DOM
            if (testResults.passed === 4) {
                document.getElementById('dom-stable').textContent = '‚úÖ';
            } else if (testResults.failed > 0) {
                document.getElementById('dom-stable').textContent = '‚ùå';
            }
        }

        async function testLogin(email, password, role) {
            const startTime = Date.now();
            testResults.total++;

            addResult(`üß™ Test de connexion pour ${role} (${email})...`, 'info');

            try {
                // 1. Test de connexion via API
                const loginResponse = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const authTime = Date.now() - startTime;
                testResults.times.push(authTime);

                if (loginResponse.ok) {
                    const data = await loginResponse.json();

                    if (data.user && data.user.role === role) {
                        testResults.passed++;
                        addResult(`‚úÖ ${role.toUpperCase()}: Login r√©ussi en ${authTime}ms`, 'success');

                        // 2. V√©rifier le cookie
                        const hasAuthCookie = document.cookie.includes('auth-token');
                        if (hasAuthCookie) {
                            addResult(`‚úÖ Cookie d'authentification pr√©sent`, 'success');
                        }

                        // 3. Test de v√©rification de session
                        const sessionResponse = await fetch('http://localhost:3000/api/auth/session', {
                            credentials: 'include'
                        });

                        if (sessionResponse.ok) {
                            addResult(`‚úÖ Session valide pour ${role}`, 'success');
                        } else {
                            addResult(`‚ö†Ô∏è Session invalide apr√®s login`, 'error');
                        }

                    } else {
                        testResults.failed++;
                        addResult(`‚ùå ${role}: R√¥le incorrect dans la r√©ponse`, 'error');
                    }
                } else {
                    testResults.failed++;
                    const errorText = await loginResponse.text();
                    addResult(`‚ùå ${role}: √âchec de connexion - ${loginResponse.status}: ${errorText}`, 'error');
                }

            } catch (error) {
                testResults.failed++;
                addResult(`‚ùå ${role}: Erreur r√©seau - ${error.message}`, 'error');
            }

            updateMetrics();
        }

        async function runAllTests() {
            addResult('üöÄ D√©marrage des tests automatis√©s...', 'info');

            // Reset des m√©triques
            testResults = { total: 0, passed: 0, failed: 0, times: [] };

            const accounts = [
                { email: 'admin@seido.pm', password: 'Wxcvbn123', role: 'admin' },
                { email: 'arthur@umumentum.com', password: 'Wxcvbn123', role: 'gestionnaire' },
                { email: 'arthur+prest@seido.pm', password: 'Wxcvbn123', role: 'prestataire' },
                { email: 'arthur+loc@seido.pm', password: 'Wxcvbn123', role: 'locataire' }
            ];

            for (const account of accounts) {
                await testLogin(account.email, account.password, account.role);
                // Attendre un peu entre les tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Rapport final
            const successRate = Math.round((testResults.passed / testResults.total) * 100);
            const avgTime = Math.round(testResults.times.reduce((a, b) => a + b, 0) / testResults.times.length);

            addResult('=' .repeat(60), 'info');
            addResult(`üìä RAPPORT FINAL - PHASE 1`, 'info');
            addResult(`‚úÖ Tests r√©ussis: ${testResults.passed}/${testResults.total}`, successRate >= 95 ? 'success' : 'error');
            addResult(`‚è±Ô∏è Temps moyen: ${avgTime}ms`, avgTime < 3000 ? 'success' : 'error');

            if (successRate >= 95 && avgTime < 3000) {
                addResult('üéâ PHASE 1 - SUCC√àS TOTAL !', 'success');
            } else {
                addResult('‚ö†Ô∏è Des am√©liorations sont n√©cessaires', 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = { total: 0, passed: 0, failed: 0, times: [] };
            updateMetrics();
        }

        // Test initial au chargement
        window.onload = () => {
            addResult('üîß Page de test charg√©e - Pr√™te pour validation', 'info');
        };
    </script>
</body>
</html>