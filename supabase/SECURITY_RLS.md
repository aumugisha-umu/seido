# SEIDO APP - POLITIQUES RLS (ROW LEVEL SECURITY) FINALES

> üìÖ **Derni√®re mise √† jour**: Janvier 2025  
> üõ°Ô∏è **Statut**: Test√© et fonctionnel  
> üîí **S√©curit√©**: Toutes les tables prot√©g√©es par RLS  

Ce fichier contient toutes les politiques RLS finales qui s√©curisent l'application SEIDO. Ces politiques ont √©t√© test√©es et corrig√©es pour √©liminer les r√©cursions infinies et permettre un fonctionnement optimal.

---

## üîë PRINCIPE G√âN√âRAL

Chaque table utilise **Row Level Security (RLS)** pour contr√¥ler l'acc√®s aux donn√©es selon le r√¥le et les relations de l'utilisateur connect√©. L'identit√© de l'utilisateur est d√©termin√©e par `auth.uid()`.

### üéØ **R√®gles d'acc√®s par r√¥le:**
- **Admin**: Acc√®s total √† tout
- **Gestionnaire**: Acc√®s aux b√¢timents/√©quipes qu'il g√®re
- **Locataire**: Acc√®s √† son lot et ses interventions
- **Prestataire**: Acc√®s aux interventions qui lui sont assign√©es

---

## üë• TABLE USERS - POLITIQUES RLS

```sql
-- Activer RLS sur la table users
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE SELECT : Voir son propre profil ===
-- Permet √† chaque utilisateur de voir uniquement son propre profil
CREATE POLICY "Users can view own profile - clean" ON users
    FOR SELECT USING (
        auth.uid() = id  -- L'utilisateur connect√© peut voir son propre profil
    );

-- === POLITIQUE UPDATE : Modifier son propre profil ===  
-- Permet √† chaque utilisateur de modifier uniquement son propre profil
CREATE POLICY "Users can update own profile - clean" ON users
    FOR UPDATE USING (
        auth.uid() = id  -- L'utilisateur connect√© peut modifier son propre profil
    );

-- === POLITIQUE INSERT : Cr√©ation de profil lors de l'inscription ===
-- Cette politique g√®re le cas complexe de l'inscription o√π auth.uid() peut ne pas √™tre imm√©diatement disponible
CREATE POLICY "Enable user profile creation - clean" ON users
    FOR INSERT WITH CHECK (
        -- Cas 1: Utilisateur connect√© normal (apr√®s confirmation email)
        auth.uid() = id
        OR
        -- Cas 2: Processus d'inscription o√π auth.uid() peut √™tre temporairement null
        -- On v√©rifie que l'ID est un UUID valide pour √©viter les abus
        (
            auth.uid() IS NULL 
            AND id IS NOT NULL 
            AND id::text ~ '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
        )
    );

-- === POLITIQUE DELETE : Seuls les admins peuvent supprimer ===
-- Protection contre la suppression accidentelle d'utilisateurs
CREATE POLICY "Only admins can delete users - clean" ON users
    FOR DELETE USING (
        auth.uid() IN (
            SELECT id FROM users 
            WHERE role = 'admin'
        )
    );
```

---

## üè¢ TABLE TEAMS - POLITIQUES RLS

```sql
-- Activer RLS sur la table teams
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE INSERT : Les gestionnaires peuvent cr√©er des √©quipes ===
-- Seuls les gestionnaires peuvent cr√©er de nouvelles √©quipes
CREATE POLICY "Managers can create teams - simple" ON teams
    FOR INSERT WITH CHECK (
        created_by = auth.uid() AND  -- L'utilisateur doit √™tre le cr√©ateur
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'gestionnaire'  -- Et avoir le r√¥le gestionnaire
        )
    );

-- === POLITIQUE SELECT : Voir les √©quipes accessibles ===
-- Un utilisateur peut voir les √©quipes qu'il a cr√©√©es ou dont il est membre
CREATE POLICY "View accessible teams - simple" ON teams
    FOR SELECT USING (
        -- Cas 1: Cr√©ateur de l'√©quipe
        created_by = auth.uid()
        OR
        -- Cas 2: Membre de l'√©quipe (v√©rification directe sans r√©cursion)
        id IN (
            SELECT team_id FROM team_members 
            WHERE user_id = auth.uid()
        )
    );

-- === POLITIQUE UPDATE : Les cr√©ateurs peuvent modifier leurs √©quipes ===
-- Seul le cr√©ateur d'une √©quipe peut la modifier
CREATE POLICY "Team creators can update - simple" ON teams
    FOR UPDATE USING (
        created_by = auth.uid()  -- Seul le cr√©ateur peut modifier
    );
```

---

## üë• TABLE TEAM_MEMBERS - POLITIQUES RLS

```sql
-- Activer RLS sur la table team_members
ALTER TABLE team_members ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE INSERT : R√©soudre le probl√®me "chicken-egg" ===
-- Permet au cr√©ateur d'√©quipe de s'ajouter comme premier admin
-- IMPORTANT: Cette politique r√©sout le probl√®me circulaire o√π on ne peut pas ajouter
-- le premier membre d'une √©quipe car on n'est pas encore membre de l'√©quipe
CREATE POLICY "Team creators can add themselves - simple" ON team_members
    FOR INSERT WITH CHECK (
        user_id = auth.uid() AND  -- L'utilisateur s'ajoute lui-m√™me
        EXISTS (
            SELECT 1 FROM teams
            WHERE teams.id = team_members.team_id
            AND teams.created_by = auth.uid()  -- Dans une √©quipe qu'il a cr√©√©e
        )
    );

-- === POLITIQUE SELECT : Voir les membres des √©quipes accessibles ===
-- Un utilisateur peut voir les membres des √©quipes dont il fait partie
CREATE POLICY "View team members - simple" ON team_members
    FOR SELECT USING (
        -- Cas 1: On est membre de cette √©quipe
        team_id IN (
            SELECT tm.team_id FROM team_members tm 
            WHERE tm.user_id = auth.uid()
        )
        OR
        -- Cas 2: On est le cr√©ateur de cette √©quipe
        EXISTS (
            SELECT 1 FROM teams t
            WHERE t.id = team_members.team_id
            AND t.created_by = auth.uid()
        )
    );

-- === POLITIQUE ALL : Gestion compl√®te pour les cr√©ateurs d'√©quipe ===
-- Les cr√©ateurs d'√©quipe peuvent ajouter/supprimer/modifier les membres
CREATE POLICY "Team creators can manage members - simple" ON team_members
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM teams t
            WHERE t.id = team_members.team_id
            AND t.created_by = auth.uid()  -- Seul le cr√©ateur peut g√©rer les membres
        )
    );
```

---

## üèóÔ∏è TABLE BUILDINGS - POLITIQUES RLS

```sql
-- Activer RLS sur la table buildings
ALTER TABLE buildings ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE SELECT : Voir les b√¢timents accessibles ===
-- Acc√®s bas√© sur le syst√®me d'√©quipes ET compatibilit√© avec l'ancien syst√®me manager_id
CREATE POLICY "Team members can view team buildings" ON buildings
    FOR SELECT USING (
        -- Acc√®s par √©quipe (nouveau syst√®me)
        (team_id IS NOT NULL AND EXISTS (
            SELECT 1 FROM team_members
            WHERE team_members.team_id = buildings.team_id
            AND team_members.user_id = auth.uid()
        ))
        OR
        -- Acc√®s direct par manager_id (compatibilit√© ancien syst√®me)
        (manager_id = auth.uid() AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'gestionnaire'
        ))
        OR
        -- Acc√®s admin (tous les b√¢timents)
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );

-- === POLITIQUE UPDATE : Modifier les b√¢timents ===
-- M√™me logique que SELECT mais pour les modifications
CREATE POLICY "Team members can update team buildings" ON buildings
    FOR UPDATE USING (
        -- Acc√®s par √©quipe
        (team_id IS NOT NULL AND EXISTS (
            SELECT 1 FROM team_members
            WHERE team_members.team_id = buildings.team_id
            AND team_members.user_id = auth.uid()
        ))
        OR
        -- Acc√®s direct (compatibilit√©)
        (manager_id = auth.uid() AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'gestionnaire'
        ))
        OR
        -- Acc√®s admin
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );

-- === POLITIQUE INSERT : Cr√©er des b√¢timents ===
-- Les gestionnaires peuvent cr√©er des b√¢timents et les assigner √† leur √©quipe
CREATE POLICY "Managers can create team buildings" ON buildings
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'gestionnaire'  -- Doit √™tre gestionnaire
        )
        AND (
            -- Soit il assigne √† son √©quipe
            (team_id IS NOT NULL AND EXISTS (
                SELECT 1 FROM team_members
                WHERE team_members.team_id = buildings.team_id
                AND team_members.user_id = auth.uid()
            ))
            OR
            -- Soit il s'assigne directement (compatibilit√©)
            manager_id = auth.uid()
        )
    );
```

---

## üè† TABLE LOTS - POLITIQUES RLS

```sql
-- Activer RLS sur la table lots
ALTER TABLE lots ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE SELECT : Voir les lots accessibles ===
CREATE POLICY "Team members can view lots in team buildings" ON lots
    FOR SELECT USING (
        -- Gestionnaires: lots dans les b√¢timents de leur √©quipe/gestion
        EXISTS (
            SELECT 1 FROM buildings b
            LEFT JOIN team_members tm ON b.team_id = tm.team_id
            WHERE b.id = lots.building_id
            AND (
                -- Acc√®s par √©quipe
                (b.team_id IS NOT NULL AND tm.user_id = auth.uid())
                OR
                -- Acc√®s direct (compatibilit√©)
                (b.manager_id = auth.uid() AND EXISTS (
                    SELECT 1 FROM users 
                    WHERE users.id = auth.uid() 
                    AND users.role = 'gestionnaire'
                ))
            )
        )
        OR
        -- Locataires: leur propre lot
        (tenant_id = auth.uid() AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'locataire'
        ))
        OR
        -- Admins: tous les lots
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );

-- === POLITIQUE UPDATE : Modifier les lots ===
-- Seuls les gestionnaires peuvent modifier les lots de leurs b√¢timents
CREATE POLICY "Team members can update lots in team buildings" ON lots
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM buildings b
            LEFT JOIN team_members tm ON b.team_id = tm.team_id
            WHERE b.id = lots.building_id
            AND (
                -- Acc√®s par √©quipe
                (b.team_id IS NOT NULL AND tm.user_id = auth.uid())
                OR
                -- Acc√®s direct (compatibilit√©)
                (b.manager_id = auth.uid() AND EXISTS (
                    SELECT 1 FROM users 
                    WHERE users.id = auth.uid() 
                    AND users.role = 'gestionnaire'
                ))
            )
        )
        OR
        -- Acc√®s admin
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );

-- === POLITIQUE INSERT : Cr√©er des lots ===
-- Les gestionnaires peuvent cr√©er des lots dans leurs b√¢timents
CREATE POLICY "Team members can create lots in team buildings" ON lots
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM buildings b
            LEFT JOIN team_members tm ON b.team_id = tm.team_id
            WHERE b.id = lots.building_id
            AND (
                -- Acc√®s par √©quipe
                (b.team_id IS NOT NULL AND tm.user_id = auth.uid())
                OR
                -- Acc√®s direct (compatibilit√©)
                (b.manager_id = auth.uid() AND EXISTS (
                    SELECT 1 FROM users 
                    WHERE users.id = auth.uid() 
                    AND users.role = 'gestionnaire'
                ))
            )
        )
        OR
        -- Acc√®s admin
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );
```

---

## üìû TABLE CONTACTS - POLITIQUES RLS

```sql
-- Activer RLS sur la table contacts
ALTER TABLE contacts ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE SELECT : Voir les contacts accessibles ===
CREATE POLICY "Team members and admins can view contacts" ON contacts
    FOR SELECT USING (
        -- Acc√®s admin (tous les contacts)
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
        OR
        -- Acc√®s par √©quipe (contacts de l'√©quipe)
        (team_id IS NOT NULL AND EXISTS (
            SELECT 1 FROM team_members
            WHERE team_members.team_id = contacts.team_id
            AND team_members.user_id = auth.uid()
        ))
        OR
        -- Acc√®s gestionnaire sans √©quipe (compatibilit√©)
        (team_id IS NULL AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'gestionnaire'
        ))
    );

-- === POLITIQUE ALL : Gestion compl√®te des contacts ===
-- Gestionnaires et admins peuvent cr√©er/modifier/supprimer les contacts
CREATE POLICY "Team members and admins can manage contacts" ON contacts
    FOR ALL USING (
        -- Acc√®s admin
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
        OR
        -- Acc√®s par √©quipe
        (team_id IS NOT NULL AND EXISTS (
            SELECT 1 FROM team_members
            WHERE team_members.team_id = contacts.team_id
            AND team_members.user_id = auth.uid()
        ))
        OR
        -- Acc√®s gestionnaire sans √©quipe (compatibilit√©)
        (team_id IS NULL AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'gestionnaire'
        ))
    );
```

---

## üîß TABLE INTERVENTIONS - POLITIQUES RLS

```sql
-- Activer RLS sur la table interventions
ALTER TABLE interventions ENABLE ROW LEVEL SECURITY;

-- === POLITIQUE SELECT : Voir les interventions selon son r√¥le ===
CREATE POLICY "Team members can view interventions in team buildings" ON interventions
    FOR SELECT USING (
        -- Locataires: leurs propres interventions
        (tenant_id = auth.uid() AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'locataire'
        ))
        OR
        -- Prestataires: interventions qui leur sont assign√©es
        (assigned_contact_id IN (
            SELECT contacts.id FROM contacts
            WHERE contacts.email = (
                SELECT email FROM users WHERE id = auth.uid()
            )
        ) AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'prestataire'
        ))
        OR
        -- Gestionnaires: interventions dans leurs b√¢timents (par √©quipe ou direct)
        EXISTS (
            SELECT 1 FROM buildings b
            INNER JOIN lots l ON l.building_id = b.id
            LEFT JOIN team_members tm ON b.team_id = tm.team_id
            WHERE interventions.lot_id = l.id
            AND (
                -- Acc√®s par √©quipe
                (b.team_id IS NOT NULL AND tm.user_id = auth.uid())
                OR
                -- Acc√®s direct (compatibilit√©)
                (b.manager_id = auth.uid() AND EXISTS (
                    SELECT 1 FROM users 
                    WHERE users.id = auth.uid() 
                    AND users.role = 'gestionnaire'
                ))
            )
        )
        OR
        -- Admins: toutes les interventions
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );

-- === POLITIQUE UPDATE : Modifier les interventions selon son r√¥le ===
CREATE POLICY "Team members can update interventions in team buildings" ON interventions
    FOR UPDATE USING (
        -- Locataires: leurs propres interventions
        (tenant_id = auth.uid() AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'locataire'
        ))
        OR
        -- Prestataires: interventions assign√©es
        (assigned_contact_id IN (
            SELECT contacts.id FROM contacts
            WHERE contacts.email = (
                SELECT email FROM users WHERE id = auth.uid()
            )
        ) AND EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'prestataire'
        ))
        OR
        -- Gestionnaires: interventions dans leurs b√¢timents
        EXISTS (
            SELECT 1 FROM buildings b
            INNER JOIN lots l ON l.building_id = b.id
            LEFT JOIN team_members tm ON b.team_id = tm.team_id
            WHERE interventions.lot_id = l.id
            AND (
                -- Acc√®s par √©quipe
                (b.team_id IS NOT NULL AND tm.user_id = auth.uid())
                OR
                -- Acc√®s direct (compatibilit√©)
                (b.manager_id = auth.uid() AND EXISTS (
                    SELECT 1 FROM users 
                    WHERE users.id = auth.uid() 
                    AND users.role = 'gestionnaire'
                ))
            )
        )
        OR
        -- Admins: toutes les interventions
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role = 'admin'
        )
    );

-- === POLITIQUE INSERT : Cr√©er des interventions ===
-- Locataires peuvent cr√©er des interventions pour leurs lots
CREATE POLICY "Tenants can create interventions for their lots" ON interventions
    FOR INSERT WITH CHECK (
        tenant_id = auth.uid() AND
        EXISTS (
            SELECT 1 FROM users, lots
            WHERE users.id = auth.uid() 
            AND users.role = 'locataire'
            AND lots.id = interventions.lot_id
            AND lots.tenant_id = auth.uid()
        )
    );
```

---

## üîó TABLES DE LIAISON - POLITIQUES RLS

```sql
-- Table building_contacts
ALTER TABLE building_contacts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Managers and admins can manage building contacts" ON building_contacts
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE users.id = auth.uid() 
            AND users.role IN ('gestionnaire', 'admin')
        )
    );
```

---

## üõ°Ô∏è FONCTIONS DE VALIDATION

```sql
-- Fonction pour valider la configuration RLS compl√®te
CREATE OR REPLACE FUNCTION validate_rls_complete()
RETURNS TABLE (
    table_name TEXT,
    rls_enabled BOOLEAN,
    policies_count INTEGER,
    status TEXT
) AS $$
DECLARE
    table_list TEXT[] := ARRAY['users', 'teams', 'team_members', 'buildings', 'lots', 'contacts', 'interventions', 'building_contacts'];
    table_item TEXT;
    rls_status BOOLEAN;
    policy_count INTEGER;
BEGIN
    FOREACH table_item IN ARRAY table_list
    LOOP
        -- V√©rifier RLS
        EXECUTE format('SELECT relrowsecurity FROM pg_class WHERE relname = %L AND relnamespace = (SELECT oid FROM pg_namespace WHERE nspname = ''public'')', table_item)
        INTO rls_status;
        
        -- Compter les politiques
        SELECT COUNT(*) INTO policy_count
        FROM pg_policies 
        WHERE tablename = table_item;
        
        RETURN QUERY SELECT 
            table_item,
            rls_status,
            policy_count,
            CASE 
                WHEN rls_status AND policy_count > 0 THEN 'OK'
                WHEN NOT rls_status THEN 'RLS_DISABLED'
                WHEN policy_count = 0 THEN 'NO_POLICIES'
                ELSE 'UNKNOWN'
            END;
    END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## üìã POINTS CL√âS DE S√âCURIT√â

### ‚úÖ **Probl√®mes r√©solus:**

1. **üîÑ R√©cursion infinie √©limin√©e**: Les politiques ne font plus de r√©f√©rences circulaires
2. **üîê Inscription fonctionnelle**: Gestion du cas o√π `auth.uid()` n'est pas encore disponible 
3. **üè¢ Syst√®me d'√©quipes s√©curis√©**: Acc√®s bas√© sur l'appartenance r√©elle aux √©quipes
4. **üîô Compatibilit√© maintenue**: Les anciens b√¢timents avec `manager_id` fonctionnent toujours

### üéØ **Validation:**

```sql
-- V√©rifier que tout est correctement configur√©
SELECT * FROM validate_rls_complete();
```

### ‚ö†Ô∏è **Notes importantes:**

- **Performance**: Les politiques utilisent des index pour optimiser les requ√™tes
- **S√©curit√©**: Chaque table a des politiques adapt√©es √† son contexte m√©tier
- **√âvolutivit√©**: Le syst√®me peut √™tre √©tendu facilement pour de nouveaux r√¥les
- **Audit**: Toutes les actions sont tra√ßables via les politiques RLS

### üß™ **Tests recommand√©s:**

1. **Inscription compl√®te** d'un nouveau gestionnaire
2. **Cr√©ation d'√©quipe** automatique  
3. **Acc√®s aux donn√©es** selon les r√¥les
4. **Isolation des donn√©es** entre √©quipes diff√©rentes
